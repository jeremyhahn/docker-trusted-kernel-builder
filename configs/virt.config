#!/bin/bash
# virt.sh - Minimal kernel configuration for virtualized environments
# Optimized for VMs, containers, and cloud deployments

# Linux EFI Stub
scripts/config --set-val CONFIG_EFI_STUB y
scripts/config --set-val CONFIG_RD_GZIP y

# Enable essential features for Alpine/server use
log "Enabling essential kernel features..."
scripts/config --enable CONFIG_EXT4_FS
scripts/config --enable CONFIG_XFS_FS
scripts/config --enable CONFIG_BTRFS_FS
scripts/config --enable CONFIG_OVERLAY_FS
scripts/config --enable CONFIG_VFAT_FS
scripts/config --enable CONFIG_ISO9660_FS
scripts/config --enable CONFIG_UDF_FS
scripts/config --enable CONFIG_SQUASHFS
scripts/config --enable CONFIG_TMPFS
scripts/config --enable CONFIG_PROC_FS
scripts/config --enable CONFIG_SYSFS
scripts/config --enable CONFIG_DEVTMPFS
scripts/config --enable CONFIG_DEVTMPFS_MOUNT

# Enable crypto and FIPS
log "Enabling FIPS kernel configuration..."

# FIPS dependencies (must be enabled BEFORE CONFIG_CRYPTO_FIPS)
# For Linux 6.12, CONFIG_CRYPTO_FIPS depends on:
#   (CRYPTO_ANSI_CPRNG || CRYPTO_DRBG) && !CRYPTO_MANAGER_DISABLE_TESTS && (MODULE_SIG || !MODULES)

log "Enabling FIPS dependencies..."
scripts/config --enable CONFIG_DEBUG_KERNEL
scripts/config --enable CONFIG_CRYPTO_MANAGER2
# DISABLE the tests disable flag (double negative = enable tests)
scripts/config --disable CONFIG_CRYPTO_MANAGER_DISABLE_TESTS
# Enable extra tests for good measure
scripts/config --enable CONFIG_CRYPTO_MANAGER_EXTRA_TESTS
scripts/config --enable CONFIG_CRYPTO_DRBG
scripts/config --enable CONFIG_CRYPTO_DRBG_MENU
scripts/config --enable CONFIG_CRYPTO_DRBG_HMAC
scripts/config --enable CONFIG_CRYPTO_DRBG_HASH
scripts/config --enable CONFIG_CRYPTO_DRBG_CTR

# Enable module signing for FIPS
scripts/config --enable CONFIG_MODULE_SIG
scripts/config --enable CONFIG_MODULE_SIG_ALL
scripts/config --enable CONFIG_MODULE_SIG_SHA256
scripts/config --set-str CONFIG_MODULE_SIG_HASH "sha256"

# Now enable FIPS (dependencies are met)
scripts/config --enable CONFIG_CRYPTO_FIPS
scripts/config --enable CONFIG_CRYPTO_FIPS_NAME
scripts/config --set-str CONFIG_CRYPTO_FIPS_NAME "Alpine Linux FIPS 140-3"

# Enable required crypto algorithms for FIPS
scripts/config --enable CONFIG_CRYPTO_SHA256
scripts/config --enable CONFIG_CRYPTO_SHA512
scripts/config --enable CONFIG_CRYPTO_AES
scripts/config --enable CONFIG_CRYPTO_AES_X86_64
scripts/config --enable CONFIG_CRYPTO_AES_NI_INTEL
scripts/config --enable CONFIG_CRYPTO_CBC
scripts/config --enable CONFIG_CRYPTO_ECB
scripts/config --enable CONFIG_CRYPTO_XTS
scripts/config --enable CONFIG_CRYPTO_GCM
scripts/config --enable CONFIG_CRYPTO_HMAC
scripts/config --enable CONFIG_CRYPTO_RSA
scripts/config --enable CONFIG_CRYPTO_USER_API_HASH
scripts/config --enable CONFIG_CRYPTO_USER_API_SKCIPHER

# Enable necessary drivers and features
scripts/config --enable CONFIG_BLK_DEV_SD
scripts/config --enable CONFIG_ATA
scripts/config --enable CONFIG_SATA_AHCI
scripts/config --enable CONFIG_SCSI
scripts/config --enable CONFIG_VIRTIO
scripts/config --enable CONFIG_VIRTIO_PCI
scripts/config --enable CONFIG_VIRTIO_BLK
scripts/config --enable CONFIG_VIRTIO_NET
scripts/config --enable CONFIG_NET
scripts/config --enable CONFIG_INET
scripts/config --enable CONFIG_PACKET

# Enable TPM (Trusted Platform Module) support
# All TPM drivers built-in (not modules) for early boot initramfs support
log "Enabling TPM kernel support (built-in for early boot)..."
scripts/config --enable CONFIG_TCG_TPM
scripts/config --enable CONFIG_TCG_TIS
scripts/config --enable CONFIG_TCG_TIS_CORE
scripts/config --enable CONFIG_TCG_CRB
scripts/config --enable CONFIG_TCG_TIS_I2C
scripts/config --enable CONFIG_TCG_TIS_I2C_CR50
scripts/config --enable CONFIG_TCG_TIS_SPI
scripts/config --enable CONFIG_TCG_TIS_I2C_ATMEL
scripts/config --enable CONFIG_TCG_TIS_I2C_INFINEON
scripts/config --enable CONFIG_TCG_TIS_I2C_NUVOTON
scripts/config --enable CONFIG_TCG_VTPM_PROXY
scripts/config --enable CONFIG_TCG_TPM2_HMAC
scripts/config --enable CONFIG_HW_RANDOM_TPM

# Enable device mapper and crypto for LUKS
scripts/config --enable CONFIG_BLK_DEV_DM
scripts/config --enable CONFIG_DM_CRYPT
scripts/config --enable CONFIG_MD
