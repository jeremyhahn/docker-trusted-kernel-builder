#!/bin/bash
# full.config - Full kernel configuration for bare metal and container deployments
# This is a standalone configuration that includes all features

# Enable crypto and FIPS
log "Building full FIPS kernel configuration..."

# Linux EFI Stub
scripts/config --set-val CONFIG_EFI_STUB y
scripts/config --set-val CONFIG_RD_GZIP y

# FIPS dependencies (must be enabled BEFORE CONFIG_CRYPTO_FIPS)
scripts/config --enable CONFIG_DEBUG_KERNEL
scripts/config --enable CONFIG_CRYPTO_MANAGER2
scripts/config --disable CONFIG_CRYPTO_MANAGER_DISABLE_TESTS
scripts/config --enable CONFIG_CRYPTO_MANAGER_EXTRA_TESTS
scripts/config --enable CONFIG_CRYPTO_DRBG
scripts/config --enable CONFIG_CRYPTO_DRBG_MENU
scripts/config --enable CONFIG_CRYPTO_DRBG_HMAC
scripts/config --enable CONFIG_CRYPTO_DRBG_HASH
scripts/config --enable CONFIG_CRYPTO_DRBG_CTR

# Enable module signing for FIPS
scripts/config --enable CONFIG_MODULE_SIG
scripts/config --enable CONFIG_MODULE_SIG_ALL
scripts/config --enable CONFIG_MODULE_SIG_SHA256
scripts/config --set-str CONFIG_MODULE_SIG_HASH "sha256"

# Now enable FIPS (dependencies are met)
scripts/config --enable CONFIG_CRYPTO_FIPS
scripts/config --enable CONFIG_CRYPTO_FIPS_NAME
scripts/config --set-str CONFIG_CRYPTO_FIPS_NAME "Alpine Linux FIPS 140-3"

# Enable required crypto algorithms for FIPS
scripts/config --enable CONFIG_CRYPTO_SHA256
scripts/config --enable CONFIG_CRYPTO_SHA512
scripts/config --enable CONFIG_CRYPTO_AES
scripts/config --enable CONFIG_CRYPTO_AES_X86_64
scripts/config --enable CONFIG_CRYPTO_AES_NI_INTEL
scripts/config --enable CONFIG_CRYPTO_CBC
scripts/config --enable CONFIG_CRYPTO_ECB
scripts/config --enable CONFIG_CRYPTO_XTS
scripts/config --enable CONFIG_CRYPTO_GCM
scripts/config --enable CONFIG_CRYPTO_HMAC
scripts/config --enable CONFIG_CRYPTO_RSA
scripts/config --enable CONFIG_CRYPTO_USER_API_HASH
scripts/config --enable CONFIG_CRYPTO_USER_API_SKCIPHER

# Enable necessary drivers and features
scripts/config --enable CONFIG_BLK_DEV_SD
scripts/config --enable CONFIG_ATA
scripts/config --enable CONFIG_SATA_AHCI
scripts/config --enable CONFIG_SCSI
scripts/config --enable CONFIG_VIRTIO
scripts/config --enable CONFIG_VIRTIO_PCI
scripts/config --enable CONFIG_VIRTIO_BLK
scripts/config --enable CONFIG_VIRTIO_NET
scripts/config --enable CONFIG_NET
scripts/config --enable CONFIG_INET
scripts/config --enable CONFIG_PACKET

# Enable TPM (Trusted Platform Module) support
log "Enabling TPM kernel support (built-in for early boot)..."
scripts/config --enable CONFIG_TCG_TPM
scripts/config --enable CONFIG_TCG_TIS
scripts/config --enable CONFIG_TCG_TIS_CORE
scripts/config --enable CONFIG_TCG_CRB
scripts/config --enable CONFIG_TCG_TIS_I2C
scripts/config --enable CONFIG_TCG_TIS_I2C_CR50
scripts/config --enable CONFIG_TCG_TIS_SPI
scripts/config --enable CONFIG_TCG_TIS_I2C_ATMEL
scripts/config --enable CONFIG_TCG_TIS_I2C_INFINEON
scripts/config --enable CONFIG_TCG_TIS_I2C_NUVOTON
scripts/config --enable CONFIG_TCG_VTPM_PROXY
scripts/config --enable CONFIG_TCG_TPM2_HMAC
scripts/config --enable CONFIG_HW_RANDOM_TPM

# Enable device mapper and crypto for LUKS
scripts/config --enable CONFIG_BLK_DEV_DM
scripts/config --enable CONFIG_DM_CRYPT
scripts/config --enable CONFIG_MD

# LUKS
scripts/config --set-val CONFIG_BLK_DEV_DM y
scripts/config --set-val CONFIG_DM_CRYPT y
scripts/config --set-val CONFIG_CRYPTO_AES y
scripts/config --set-val CONFIG_CRYPTO_XTS y
scripts/config --set-val CONFIG_CRYPTO_SHA256 y

# TPM 2.0
scripts/config --set-val CONFIG_PNP y
scripts/config --set-val CONFIG_ACPI y
scripts/config --set-val CONFIG_PNPACPI y
scripts/config --set-val CONFIG_TCG_TPM y
scripts/config --set-val CONFIG_TCG_TIS y
scripts/config --set-val CONFIG_TCG_TIS_CORE y
scripts/config --set-val CONFIG_TPM_CRB y
scripts/config --set-val CONFIG_TPM_RM y
#scripts/config --set-val CONFIG_HW_RANDOM y

# Containers
scripts/config --set-val CONFIG_NAMESPACES y

# Containers :: Generally necessary
scripts/config --set-val CONFIG_NET_NS y
scripts/config --set-val CONFIG_PID_NS y
scripts/config --set-val CONFIG_IPC_NS y
scripts/config --set-val CONFIG_UTS_NS y
scripts/config --set-val CONFIG_CGROUPS y
scripts/config --set-val CONFIG_CGROUP_CPUACCT y
scripts/config --set-val CONFIG_CGROUP_DEVICE y
scripts/config --set-val CONFIG_CGROUP_FREEZER y
scripts/config --set-val CONFIG_CGROUP_SCHED y
scripts/config --set-val CONFIG_CPUSETS y
scripts/config --set-val CONFIG_MEMCG y
scripts/config --set-val CONFIG_KEYS y
scripts/config --set-val CONFIG_VETH y
scripts/config --set-val CONFIG_BRIDGE y
scripts/config --set-val CONFIG_BRIDGE_NETFILTER y
scripts/config --set-val CONFIG_NF_NAT_IPV4 y
scripts/config --set-val CONFIG_IP_NF_FILTER y
scripts/config --set-val CONFIG_IP_NF_TARGET_MASQUERADE y
scripts/config --set-val CONFIG_NETFILTER_XT_MATCH_ADDRTYPE y
scripts/config --set-val CONFIG_NETFILTER_XT_MATCH_CONNTRACK y
scripts/config --set-val CONFIG_NETFILTER_XT_MATCH_IPVS y
scripts/config --set-val CONFIG_IP_NF_NAT y
scripts/config --set-val CONFIG_NF_NAT y
scripts/config --set-val CONFIG_NF_NAT_NEEDED y
scripts/config --set-val CONFIG_POSIX_MQUEUE y
scripts/config --set-val CONFIG_BPF y
scripts/config --set-val CONFIG_BPF_SYSCALL y
scripts/config --set-val CONFIG_CGROUP_BPF y
scripts/config --set-val CONFIG_CGROUP_RDMA y
scripts/config --set-val CONFIG_CGROUP_NET_PRIO y
scripts/config --set-val CONFIG_CGROUP_NET_CLASSID y
scripts/config --set-val CONFIG_CGROUP_CPUSET y
scripts/config --set-val CONFIG_DEVPTS_MULTIPLE_INSTANCES y
scripts/config --set-val CONFIG_BPF_JIT y
scripts/config --set-val CONFIG_HAVE_EBPF_JIT y
scripts/config --set-val CONFIG_BPF_LSM y
scripts/config --set-val CONFIG_BPF_UNPRIV_DEFAULT_OFF y
scripts/config --set-val CONFIG_BPF_EVENTS y

# Containers :: Optional features
scripts/config --set-val CONFIG_USER_NS y
scripts/config --set-val CONFIG_SECCOMP y
scripts/config --set-val CONFIG_CGROUP_PIDS y
scripts/config --set-val CONFIG_MEMCG_SWAP y
scripts/config --set-val CONFIG_MEMCG_SWAP_ENABLED y
scripts/config --set-val CONFIG_BLK_CGROUP y
scripts/config --set-val CONFIG_BLK_DEV_THROTTLING y
scripts/config --set-val CONFIG_IOSCHED_CFQ y
scripts/config --set-val CONFIG_CFQ_GROUP_IOSCHED y
scripts/config --set-val CONFIG_CGROUP_PERF y
scripts/config --set-val CONFIG_CGROUP_HUGETLB y
scripts/config --set-val CONFIG_NET_CLS_CGROUP y
scripts/config --set-val CONFIG_CGROUP_NET_PRIO y
scripts/config --set-val CONFIG_CFS_BANDWIDTH y
scripts/config --set-val CONFIG_FAIR_GROUP_SCHED y
scripts/config --set-val CONFIG_RT_GROUP_SCHED y
scripts/config --set-val CONFIG_IP_NF_TARGET_REDIRECT y
scripts/config --set-val CONFIG_IP_VS y
scripts/config --set-val CONFIG_IP_VS_NFCT y
scripts/config --set-val CONFIG_IP_VS_PROTO_TCP y
scripts/config --set-val CONFIG_IP_VS_PROTO_UDP y
scripts/config --set-val CONFIG_IP_VS_RR y
scripts/config --set-val CONFIG_EXT4_FS y
scripts/config --set-val CONFIG_EXT4_FS_POSIX_ACL y
scripts/config --set-val CONFIG_EXT4_FS_SECURITY y
scripts/config --set-val CONFIG_VXLAN y
scripts/config --set-val CONFIG_XFRM y
scripts/config --set-val CONFIG_XFRM_USER y
scripts/config --set-val CONFIG_XFRM_ALGO y
scripts/config --set-val CONFIG_INET_ESP y
scripts/config --set-val CONFIG_INET_XFRM_MODE_TRANSPORT y
scripts/config --set-val CONFIG_IPVLAN y
scripts/config --set-val CONFIG_MACVLAN y
scripts/config --set-val CONFIG_DUMMY y
scripts/config --set-val CONFIG_NF_NAT_FTP y
scripts/config --set-val CONFIG_NF_CONNTRACK_FTP y
scripts/config --set-val CONFIG_NF_NAT_TFTP y
scripts/config --set-val CONFIG_NF_CONNTRACK_TFTP y
scripts/config --set-val CONFIG_AUFS_FS y
scripts/config --set-val CONFIG_BTRFS_FS y
scripts/config --set-val CONFIG_BTRFS_FS_POSIX_ACL y
scripts/config --set-val CONFIG_BLK_DEV_DM y
scripts/config --set-val CONFIG_DM_THIN_PROVISIONING y
scripts/config --set-val CONFIG_OVERLAY_FS y

# Bridge / Netfilter
scripts/config --set-val CONFIG_BRIDGE y
scripts/config --set-val CONFIG_BRIDGE_NETFILTER y
scripts/config --set-val CONFIG_NETFILTER y
scripts/config --set-val CONFIG_NETFILTER_ADVANCED y
scripts/config --set-val CONFIG_NF_CONNTRACK y
scripts/config --set-val CONFIG_NF_TABLES y
scripts/config --set-val CONFIG_NF_NAT y
scripts/config --set-val CONFIG_NF_NAT_IPV4 y
scripts/config --set-val CONFIG_NF_NAT_IPV6 y
scripts/config --set-val CONFIG_NF_TABLES_IPV4 y
scripts/config --set-val CONFIG_NF_TABLES_IPV6 y
scripts/config --set-val CONFIG_IP_NF_IPTABLES y
scripts/config --set-val CONFIG_IP_NF_FILTER y
scripts/config --set-val CONFIG_IP_NF_NAT y
scripts/config --set-val CONFIG_IP_NF_TARGET_MASQUERADE y

# Open vSwitch
scripts/config --set-val CONFIG_OPENVSWITCH y

# Security
scripts/config --set-val CONFIG_IMA y
scripts/config --set-val CONFIG_IMA_SECURE_AND_OR_TRUSTED_BOOT y
scripts/config --set-val CONFIG_SECURITY_SELINUX y
scripts/config --set-val CONFIG_DEFAULT_SECURITY_SELINUX y
scripts/config --set-val CONFIG_SECURITY_LOCKDOWN y

# Public-key cryptography
scripts/config --set-val CONFIG_CRYPTO_RSA y
scripts/config --set-val CONFIG_CRYPTO_DH y
scripts/config --set-val CONFIG_CRYPTO_ECDH y
scripts/config --set-val CONFIG_CRYPTO_ECDSA y

# Block ciphers
scripts/config --set-val CONFIG_CRYPTO_AES y

# Compression
scripts/config --set-val CONFIG_CRYPTO_LZO y
scripts/config --set-val CONFIG_CRYPTO_ZSTD y

# Crypto library routines
scripts/config --set-val CONFIG_CRYPTO_LIB_UTILS y
scripts/config --set-val CONFIG_CRYPTO_LIB_AES y
scripts/config --set-val CONFIG_CRYPTO_LIB_SHA1 y
scripts/config --set-val CONFIG_CRYPTO_LIB_SHA256 y

# AEAD (authenticated encryption with associated data) ciphers
scripts/config --set-val CONFIG_CRYPTO y
scripts/config --set-val CONFIG_CRYPTO_AEAD y
scripts/config --set-val CONFIG_CRYPTO_CBC y
scripts/config --set-val CONFIG_CRYPTO_CCM y
scripts/config --set-val CONFIG_CRYPTO_CFB y
scripts/config --set-val CONFIG_CRYPTO_CCM y
scripts/config --set-val CONFIG_CRYPTO_GCM y
scripts/config --set-val CONFIG_CRYPTO_HMAC y
scripts/config --set-val CONFIG_CRYPTO_SEQIV y
scripts/config --set-val CONFIG_CRYPTO_ECHAINIV y
scripts/config --set-val CONFIG_CRYPTO_ESSIV y

# Hashes, digests, and MACs
scripts/config --set-val CONFIG_CRYPTO_CMAC y
scripts/config --set-val CONFIG_CRYPTO_GHASH y
scripts/config --set-val CONFIG_CRYPTO_HMAC y
scripts/config --set-val CONFIG_CRYPTO_LZO y
scripts/config --set-val CONFIG_CRYPTO_SHA1 y
scripts/config --set-val CONFIG_CRYPTO_SHA256 y
scripts/config --set-val CONFIG_CRYPTO_SHA512 y
scripts/config --set-val CONFIG_CRYPTO_ZLIB y

# Custom hardening :: See https://kspp.github.io/Recommended_Settings.html
scripts/config --set-val CONFIG_SECURITY_LOCKDOWN_LSM y
scripts/config --set-val CONFIG_SECURITY_LOCKDOWN_LSM_EARLY y
scripts/config --set-val CONFIG_LOCK_DOWN_KERNEL_FORCE_CONFIDENTIALITY y
scripts/config --set-val CONFIG_SYSTEM_TRUSTED_KEYS y
